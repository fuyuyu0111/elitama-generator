<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エリたま編成ジェネレーター</title>
    <style>
        /* 全体のスタイル */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; font-size: 1.2em; }
        
        /* 上部：選択中の編成エリア */
        .party-area { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; min-height: 180px; }
        .party-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        
        .party-member-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            min-height: 160px;
        }
        /* ★ キャラアイコンとタイプアイコンの間隔を詰めるため、上下マージンを5pxから2pxに縮小 */
        .party-member-card .main-icon { width: 75px; height: 75px; cursor: pointer; border: 2px solid #007bff; border-radius: 8px; margin: 2px 0; order: 3; }
        
        .base-info-container {
            order: 1;
            display: flex;
            flex-direction: column;
            min-height: 42px;
            /* ★ 基本情報アイコンとタイプアイコンの段の間隔を広げる */
            gap: 4px;
        }
        .icon-container { display: flex; flex-wrap: wrap; gap: 0px; justify-content: center; min-height: 20px; }
        .requirements-container { order: 4; }
        .info-icon, .req-icon-wrapper img { width: 20px; height: 20px; }
        
        /* ★ 編成中キャラの名前用のスタイルを追加 */
        .party-member-name {
            order: 2; /* アイコンの上に表示 */
            font-size: 7px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2px;
        }
        
        .req-icon-wrapper { position: relative; }
        
        /* ○✗マークのスタイル */
        .req-icon-wrapper::after { content: ''; position: absolute; bottom: -3px; right: -3px; width: 12px; height: 12px; border-radius: 50%; background-color: grey; color: white; font-size: 9px; font-weight: bold; display: none; align-items: center; justify-content: center; border: 1px solid white; }
        .req-icon-wrapper.visible::after { display: flex; }
        .req-icon-wrapper.satisfied-true::after { content: '◯'; background-color: #28a745; }
        .req-icon-wrapper.satisfied-false::after { content: '✗'; background-color: #dc3545; }


        /* 下部：エイリアン選択リスト */
        .selection-area { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .alien-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 8px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .alien-card { position: relative; border: 2px solid transparent; border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .alien-card:hover { border-color: #007bff; }
        .alien-card.selected { filter: contrast(60%); }
        .alien-card.selected::after { content: '編成中'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; }
        .alien-card img { width: 100%; height: auto; }
        /* ★ 一覧のキャラ名を表示するためのスタイルを追加 */
        .alien-card .alien-name {
            display: block; /* 非表示から表示に変更 */
            font-size: 6.5px;
            letter-spacing: -0.5px;
            margin-top: 2px;
            font-weight: bold;
            line-height: 1.2;
            color: #333;
        }

        /* スマホ表示用のスタイル */
        @media (max-width: 768px) {
            .party-area { overflow-x: auto; }
            .party-display { justify-content: flex-start; flex-wrap: nowrap; padding-bottom: 10px; }
            .party-member-card { flex-shrink: 0; }
            .alien-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="party-area">
            <h2>選択中の編成</h2>
            <div id="party-display" class="party-display">
            </div>
        </div>

        <div class="selection-area">
            <h2>エイリアン一覧 (タップで編成)</h2>
            <div class="alien-grid">
                {% for alien in aliens %}
                <div class="alien-card" 
                     data-id="{{ alien.id }}" 
                     data-name="{{ alien.name }}"
                     data-info-a="{{ alien.attribute }}"
                     data-info-b="{{ alien.affiliation }}"
                     data-info-c="{{ alien.attack_area }}"
                     data-info-d="{{ alien.attack_range }}"
                     data-info-e1="{{ alien.type_1 }}"
                     data-info-e2="{{ alien.type_2 }}"
                     data-info-e3="{{ alien.type_3 }}"
                     data-info-e4="{{ alien.type_4 }}"
                     data-info-f="{{ alien.role }}">
                    <img src="/static/images/{{ alien.id }}.png" alt="{{ alien.name }}">
                    <div class="alien-name">{{ alien.name }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        const ALL_REQUIREMENTS = JSON.parse('{{ all_requirements_json | safe }}');
        // const MAX_PARTY_SIZE = 6; // ★ 上限をなくすため、この行を削除またはコメントアウト
        const alienCards = document.querySelectorAll('.alien-card');
        const partyDisplay = document.getElementById('party-display');
        let party = [];

        alienCards.forEach(card => {
            card.addEventListener('click', () => {
                if (card.classList.contains('selected')) {
                    removeFromParty(card.dataset.id);
                } else {
                    addToParty(card.dataset);
                }
            });
        });
        
        function addToParty(alienData) {
            // ★ 編成数の上限チェックを削除
            // if (party.length >= MAX_PARTY_SIZE) {
            //     alert(`編成は最大${MAX_PARTY_SIZE}体までです。`);
            //     return;
            // }
            party.push(alienData);
            updatePartyDisplay();
            checkPartyRealtime();
        }

        function removeFromParty(alienId) {
            party = party.filter(alien => alien.id !== alienId);
            updatePartyDisplay();
            checkPartyRealtime();
        }
        
        function updatePartyDisplay() {
            partyDisplay.innerHTML = '';
            
            party.forEach(alienData => {
                const memberCard = document.createElement('div');
                memberCard.className = 'party-member-card';
                
                let baseInfoRow1HTML = '';
                let baseInfoRow2HTML = '';

                if(alienData.infoB && alienData.infoB !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/b${alienData.infoB}.png">`;
                if(alienData.infoC && alienData.infoC !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/c${alienData.infoC}.png">`;
                if(alienData.infoD && alienData.infoD !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/d${alienData.infoD}.png">`;
                if(alienData.infoF && alienData.infoF !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/f${alienData.infoF}.png">`;

                if(alienData.infoE1 && alienData.infoE1 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE1}.png">`;
                if(alienData.infoE2 && alienData.infoE2 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE2}.png">`;
                if(alienData.infoE3 && alienData.infoE3 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE3}.png">`;
                if(alienData.infoE4 && alienData.infoE4 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE4}.png">`;
                
                const baseInfoContainerHTML = `
                    <div class="base-info-container">
                        <div class="icon-container">${baseInfoRow1HTML}</div>
                        <div class="icon-container">${baseInfoRow2HTML}</div>
                    </div>
                `;

                let requirementsHTML = '';
                const alienReqs = ALL_REQUIREMENTS[alienData.id] || [];
                alienReqs.forEach(req => {
                    const iconFile = `${req.condition_type}${req.condition_value}.png`;
                    requirementsHTML += `
                        <div class="req-icon-wrapper" data-alien-id="${alienData.id}" data-skill-num="${req.skill_number}" data-cond-type="${req.condition_type}" data-cond-val="${req.condition_value}">
                            <img src="/static/icon/${iconFile}">
                        </div>`;
                });

                const mainIconPath = `/static/images/${alienData.id}.png`;
                const mainIconHTML = `<img src="${mainIconPath}" alt="${alienData.name}" class="main-icon">`;
                
                // ★ 編成中キャラの名前を表示するHTMLを追加
                const nameHTML = `<div class="party-member-name">${alienData.name}</div>`;

                // ★ 表示順を order プロパティで制御するため、innerHTMLの順序を修正
                memberCard.innerHTML = `
                    ${baseInfoContainerHTML}
                    ${nameHTML}
                    ${mainIconHTML}
                    <div class="requirements-container icon-container">${requirementsHTML}</div>
                `;

                memberCard.querySelector('.main-icon').addEventListener('click', () => removeFromParty(alienData.id));
                partyDisplay.appendChild(memberCard);
            });

            alienCards.forEach(card => {
                if (party.some(alien => alien.id === card.dataset.id)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        function checkPartyRealtime() {
            // (この関数は変更なし)
            document.querySelectorAll('.req-icon-wrapper').forEach(wrapper => {
                wrapper.classList.remove('visible', 'satisfied-true', 'satisfied-false');
            });

            if (party.length < 2) {
                return;
            }

            const party_composition = { 'a': {}, 'b': {}, 'c': {}, 'd': {}, 'e': {}, 'f': {} };
            party.forEach(member => {
                if(member.infoA && member.infoA !== 'None') party_composition.a[member.infoA] = (party_composition.a[member.infoA] || 0) + 1;
                if(member.infoB && member.infoB !== 'None') party_composition.b[member.infoB] = (party_composition.b[member.infoB] || 0) + 1;
                if(member.infoC && member.infoC !== 'None') party_composition.c[member.infoC] = (party_composition.c[member.infoC] || 0) + 1;
                if(member.infoD && member.infoD !== 'None') party_composition.d[member.infoD] = (party_composition.d[member.infoD] || 0) + 1;
                if(member.infoF && member.infoF !== 'None') party_composition.f[member.infoF] = (party_composition.f[member.infoF] || 0) + 1;

                for (let i = 1; i <= 4; i++) {
                    const type = member[`infoE${i}`];
                    if (type && type !== 'None') {
                        party_composition.e[type] = (party_composition.e[type] || 0) + 1;
                    }
                }
            });

            party.forEach(member => {
                const memberId = member.id;
                const memberRequirements = ALL_REQUIREMENTS[memberId] || [];

                memberRequirements.forEach(req => {
                    const cond_type = req.condition_type;
                    const cond_value = String(req.condition_value);
                    const cond_count = req.condition_count;

                    let actual_count = party_composition[cond_type]?.[cond_value] || 0;

                    let is_self_condition = false;
                    if (cond_type === 'a' && member.infoA === cond_value) is_self_condition = true;
                    if (cond_type === 'b' && member.infoB === cond_value) is_self_condition = true;
                    if (cond_type === 'c' && member.infoC === cond_value) is_self_condition = true;
                    if (cond_type === 'd' && member.infoD === cond_value) is_self_condition = true;
                    if (cond_type === 'f' && member.infoF === cond_value) is_self_condition = true;
                    if (cond_type === 'e' && [member.infoE1, member.infoE2, member.infoE3, member.infoE4].includes(cond_value)) {
                        is_self_condition = true;
                    }
                    
                    if (is_self_condition) {
                        actual_count -= 1;
                    }

                    const is_satisfied = actual_count >= cond_count;

                    const targetIcon = document.querySelector(`.req-icon-wrapper[data-alien-id='${memberId}'][data-skill-num='${req.skill_number}'][data-cond-type='${cond_type}'][data-cond-val='${cond_value}']`);
                    if (targetIcon) {
                        targetIcon.classList.add('visible', is_satisfied ? 'satisfied-true' : 'satisfied-false');
                    }
                });
            });
        }
    </script>
</body>
</html>