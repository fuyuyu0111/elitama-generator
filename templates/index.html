<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エリたま編成ジェネレーター</title>
    <style>
        /* 全体のスタイル */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-top: 0; font-size: 1.2em; }
        
        /* 上部：選択中の編成エリア */
        .party-area { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; min-height: 180px; }
        .party-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        
        .party-member-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 80px;
            min-height: 160px; /* カード自体の高さを固定し、ガタつきを防止 */
        }
        .party-member-card .main-icon { width: 75px; height: 75px; cursor: pointer; border: 2px solid #007bff; border-radius: 8px; margin: 5px 0; order: 2; }
        
        /* 基本情報コンテナをフレックスにして2段組みに対応 */
        .base-info-container {
            order: 1;
            display: flex;
            flex-direction: column;
            min-height: 54px; /* 2段分の高さをあらかじめ確保 */
        }
        .icon-container { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; min-height: 26px; } /* 1段分の高さを確保 */
        .requirements-container { order: 3; }
        .info-icon, .req-icon-wrapper img { width: 24px; height: 24px; }
        .req-icon-wrapper { position: relative; }
        
        /* ○✗マークのスタイル */
        .req-icon-wrapper::after { content: ''; position: absolute; bottom: -3px; right: -3px; width: 12px; height: 12px; border-radius: 50%; background-color: grey; color: white; font-size: 9px; font-weight: bold; display: none; align-items: center; justify-content: center; border: 1px solid white; }
        .req-icon-wrapper.visible::after { display: flex; }
        .req-icon-wrapper.satisfied-true::after { content: '◯'; background-color: #28a745; }
        .req-icon-wrapper.satisfied-false::after { content: '✗'; background-color: #dc3545; }


        /* 下部：エイリアン選択リスト */
        .selection-area { background-color: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .alien-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 8px; /* アイコン間隔を狭くする */
            max-height: 50vh;
            overflow-y: auto;
        }
        .alien-card { position: relative; border: 2px solid transparent; border-radius: 8px; padding: 5px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .alien-card:hover { border-color: #007bff; }
        .alien-card.selected { filter: contrast(60%); }
        .alien-card.selected::after { content: '編成中'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; }
        .alien-card img { width: 100%; height: auto; }

        /* スマホ表示用のスタイル */
        @media (max-width: 768px) {
            .party-area { overflow-x: auto; }
            .party-display { justify-content: flex-start; flex-wrap: nowrap; padding-bottom: 10px; }
            .party-member-card { flex-shrink: 0; }
            /* スマホで5列表示になるように調整 */
            .alien-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="party-area">
            <h2>選択中の編成</h2>
            <div id="party-display" class="party-display">
                </div>
        </div>

        <div class="selection-area">
            <h2>エイリアン一覧 (タップで編成)</h2>
            <div class="alien-grid">
                {% for alien in aliens %}
                <div class="alien-card" 
                     data-id="{{ alien.id }}" 
                     data-name="{{ alien.name }}"
                     data-info-a="{{ alien.attribute }}"
                     data-info-b="{{ alien.affiliation }}"
                     data-info-c="{{ alien.attack_area }}"
                     data-info-d="{{ alien.attack_range }}"
                     data-info-e1="{{ alien.type_1 }}"
                     data-info-e2="{{ alien.type_2 }}"
                     data-info-e3="{{ alien.type_3 }}">
                    <img src="/static/images/{{ alien.id }}.png" alt="{{ alien.name }}">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // Pythonから渡された全要求データをJavaScriptの変数として受け取る
        const ALL_REQUIREMENTS = JSON.parse('{{ all_requirements_json | safe }}');

        const MAX_PARTY_SIZE = 6;
        const alienCards = document.querySelectorAll('.alien-card');
        const partyDisplay = document.getElementById('party-display');
        let party = []; // 現在の編成を管理する配列

        // エイリアン一覧のカードがクリックされた時の処理
        alienCards.forEach(card => {
            card.addEventListener('click', () => {
                if (card.classList.contains('selected')) {
                    removeFromParty(card.dataset.id);
                } else {
                    addToParty(card.dataset);
                }
            });
        });
        
        // 編成にエイリアンを追加する関数
        function addToParty(alienData) {
            if (party.length >= MAX_PARTY_SIZE) {
                alert(`編成は最大${MAX_PARTY_SIZE}体までです。`);
                return;
            }
            party.push(alienData);
            updatePartyDisplay();
            checkPartyRealtime();
        }

        // 編成からエイリアンを削除する関数
        function removeFromParty(alienId) {
            party = party.filter(alien => alien.id !== alienId);
            updatePartyDisplay();
            checkPartyRealtime();
        }
        
        // 編成エリアの表示を更新する関数
        function updatePartyDisplay() {
            partyDisplay.innerHTML = '';
            
            party.forEach(alienData => {
                const memberCard = document.createElement('div');
                memberCard.className = 'party-member-card';
                
                // 基本情報アイコンの生成
                let baseInfoRow1HTML = ''; // 1段目 (a, b, c, d)
                let baseInfoRow2HTML = ''; // 2段目 (e)

                //if(alienData.infoA && alienData.infoA !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/a${alienData.infoA}.png">`;
                if(alienData.infoB && alienData.infoB !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/b${alienData.infoB}.png">`;
                if(alienData.infoC && alienData.infoC !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/c${alienData.infoC}.png">`;
                if(alienData.infoD && alienData.infoD !== 'None') baseInfoRow1HTML += `<img class="info-icon" src="/static/icon/d${alienData.infoD}.png">`;

                if(alienData.infoE1 && alienData.infoE1 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE1}.png">`;
                if(alienData.infoE2 && alienData.infoE2 !== 'None') baseInfoRow2HTML += `<img class="info-icon" src="/static/icon/e${alienData.infoE2}.png">`;
                if(alienData.infoE3 && alienData.infoE3 !== 'None') baseInfoRow2HTML += `<img class.="info-icon" src="/static/icon/e${alienData.infoE3}.png">`;
                
                const baseInfoContainerHTML = `
                    <div class="base-info-container">
                        <div class="icon-container">${baseInfoRow1HTML}</div>
                        <div class="icon-container">${baseInfoRow2HTML}</div>
                    </div>
                `;

                // 要求アイコン (常に表示)
                let requirementsHTML = '';
                const alienReqs = ALL_REQUIREMENTS[alienData.id] || [];
                alienReqs.forEach(req => {
                    const iconFile = `${req.condition_type}${req.condition_value}.png`;
                    requirementsHTML += `
                        <div class="req-icon-wrapper" data-alien-id="${alienData.id}" data-skill-num="${req.skill_number}" data-cond-type="${req.condition_type}" data-cond-val="${req.condition_value}">
                            <img src="/static/icon/${iconFile}">
                        </div>`;
                });

                const mainIconPath = `/static/images/${alienData.id}.png`;
                const mainIconHTML = `<img src="${mainIconPath}" alt="${alienData.name}" class="main-icon">`;

                memberCard.innerHTML = `
                    ${baseInfoContainerHTML}
                    ${mainIconHTML}
                    <div class="requirements-container icon-container">${requirementsHTML}</div>
                `;

                memberCard.querySelector('.main-icon').addEventListener('click', () => removeFromParty(alienData.id));
                partyDisplay.appendChild(memberCard);
            });

            alienCards.forEach(card => {
                if (party.some(alien => alien.id === card.dataset.id)) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        // リアルタイムで判定を行う関数
        async function checkPartyRealtime() {
            const selectedIds = party.map(alien => alien.id);
            
            document.querySelectorAll('.req-icon-wrapper').forEach(wrapper => {
                wrapper.classList.remove('visible', 'satisfied-true', 'satisfied-false');
            });

            if (selectedIds.length < 2) {
                return;
            }

            const response = await fetch('/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selectedIds }),
            });
            const results = await response.json();

            results.forEach(alienResult => {
                alienResult.requirements.forEach(req => {
                    const targetIcon = document.querySelector(`.req-icon-wrapper[data-alien-id='${alienResult.id}'][data-skill-num='${req.skill_number}'][data-cond-type='${req.condition_type}'][data-cond-val='${req.condition_value}']`);
                    if (targetIcon) {
                        targetIcon.classList.add('visible', req.is_satisfied ? 'satisfied-true' : 'satisfied-false');
                    }
                });
            });
        }
    </script>
</body>
</html>