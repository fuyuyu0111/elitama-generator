name: 日次スクレイピング自動実行

on:
  schedule:
    # 毎日午前0時（JST = UTC+9、つまりUTC 15:00）に実行
    - cron: '0 15 * * *'
  workflow_dispatch:  # 手動実行も可能

jobs:
  scrape-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
      
      - name: Python環境をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 依存関係をインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: スクレイピングと解析を実行
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          SCRAPING_BASE_URL: ${{ secrets.SCRAPING_BASE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python scripts/run_automated_update.py \
            --url "$SCRAPING_BASE_URL" \
            --discord-webhook "$DISCORD_WEBHOOK_URL"
      
      - name: エラー時のDiscord通知
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            python -c "
import os
import sys
from pathlib import Path
sys.path.insert(0, str(Path('scripts/utils').resolve()))
from discord_notifier import DiscordNotifier
try:
    notifier = DiscordNotifier(os.environ.get('DISCORD_WEBHOOK_URL'))
    notifier.send_error(
        'GitHub Actionsでスクレイピング処理が失敗しました。',
        Exception('ワークフローのログを確認してください。')
    )
except Exception as e:
    print(f'Discord通知送信エラー: {e}')
"
          fi

