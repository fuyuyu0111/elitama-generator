name: 日次スクレイピング自動実行

on:
  schedule:
    # 毎日午前0時2分（JST = UTC+9、つまりUTC 15:02）に実行
    - cron: '2 15 * * *'
  workflow_dispatch:  # 手動実行も可能

permissions:
  contents: write

jobs:
  scrape-and-analyze:
    runs-on: ubuntu-latest
    
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Python環境をセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: 依存関係をインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: スクレイピングと解析を実行
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GEMINI_API_KEY_2: ${{ secrets.GEMINI_API_KEY_2 }}
          SCRAPING_BASE_URL: ${{ secrets.SCRAPING_BASE_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          AUTO_GIT_PUSH: "1"
          AUTO_GIT_BRANCH: "main"
          AUTO_GIT_REMOTE: "origin"
          AUTO_GIT_USER_NAME: "github-actions[bot]"
          AUTO_GIT_USER_EMAIL: "github-actions[bot]@users.noreply.github.com"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/run_automated_update.py \
            --url "$SCRAPING_BASE_URL" \
            --discord-webhook "$DISCORD_WEBHOOK_URL"
          # 注意: デフォルトで逆順スクレイピング（最新から）が実行されます
          # 全体スクレイピングが必要な場合は、管理モードから手動で実行してください
      
      - name: エラー時のDiscord通知
        if: failure()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        shell: python
        run: |
          import os
          import sys
          from pathlib import Path

          webhook = os.environ.get('DISCORD_WEBHOOK_URL')
          if not webhook:
              raise SystemExit(0)

          sys.path.insert(0, str(Path('scripts/utils').resolve()))
          from discord_notifier import DiscordNotifier

          try:
              notifier = DiscordNotifier(webhook)
              notifier.send_error(
                  'GitHub Actionsでスクレイピング処理が失敗しました。',
                  Exception('ワークフローのログを確認してください。')
              )
          except Exception as e:
              print(f'Discord通知送信エラー: {e}')

